{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Журнал</h2>

  <!-- Навигация по вкладкам -->
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link {% if tab == 'sales' %}active{% endif %}" href="?tab=sales">Продажи</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if tab == 'service' %}active{% endif %}" href="?tab=service">Сервис</a>
    </li>
  </ul>

  <!-- Фильтры -->
  <form method="get" class="row mt-3">
    <input type="hidden" name="tab" value="{{ tab }}">
    <div class="col-md-4"><input name="search" value="{{ search }}" class="form-control" placeholder="Поиск..."></div>
    <div class="col-md-3">
      <select name="order" class="form-select">
        <option value="-date" {% if order == "-date" %}selected{% endif %}>Сначала новые</option>
        <option value="date" {% if order == "date" %}selected{% endif %}>Сначала старые</option>
      </select>
    </div>
    <div class="col-md-2"><button class="btn btn-primary w-100">Фильтр</button></div>
    <div class="col-md-3 text-end">
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#journalModal">
        + Добавить запись
      </button>
    </div>
  </form>

  <!-- Таблица -->
  <table class="table table-striped mt-3">
    <thead>
      <tr>
        <th>Дата</th>
        <th>Клиент</th>
        <th>Телефон</th>
        {% if tab == "service" %}
        <th>Машина</th>
        <th>Услуга</th>
        {% endif %}
        <th>Комментарий</th>
      </tr>
    </thead>
    <tbody>
      {% for j in journals %}
        <tr>
          <td>{{ j.date }}</td>
          <td>{{ j.client }}</td>
          <td>{{ j.phone }}</td>
          {% if tab == "service" %}
          <td>{{ j.vehicle }}</td>
          <td>{{ j.service }}</td>
          {% endif %}
          <td>{{ j.comment }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="6" class="text-center">Нет записей</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Модальное окно -->
{% include "journals/journal_modal.html" %}

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('.js-select2-client').select2({ width: '100%' });
    $('.js-select2-vehicle').select2({ width: '100%' });
    $('.js-select2-service').select2({ width: '100%' });

    // автозаполнение телефона при выборе клиента
    $('.js-select2-client').on('change', function() {
        var phone = $(this).find(':selected').data('phone');
        $('#id_phone').val(phone);
    });

    // автозаполнение машины для сервиса
    $('.js-select2-vehicle').on('change', function() {
        // при желании можно подтягивать бренд/модель
    });
});
</script>
{% endblock %}
