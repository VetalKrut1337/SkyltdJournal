{% extends "base.html" %}
{% block title %}Машини{% endblock %}

{% block content %}

<h2 class="mb-3">Машини</h2>

<div class="row mb-3">
    <div class="col-md-4">
        <input id="searchInput" type="text" class="form-control" placeholder="Пошук по номеру, бренду або моделі...">
    </div>

    <div class="col-md-4">
        <select id="sortSelect" class="form-select">
            <option value="">Сортувати...</option>
            <option value="plate_number">Номер (A→Z)</option>
            <option value="-plate_number">Номер (Z→A)</option>
            <option value="brand">Бренд (A→Z)</option>
            <option value="-brand">Бренд (Z→A)</option>
            <option value="model">Модель (A→Z)</option>
            <option value="-model">Модель (Z→A)</option>
        </select>
    </div>

    <div class="col-md-4 text-end">
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createVehicleModal">
            Додати машину
        </button>
        <button class="btn btn-primary" onclick="loadVehicles()">
            Оновити список
        </button>
    </div>
</div>

<div id="loadingSpinner" class="text-center py-5" style="display: none;">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Завантаження...</span>
    </div>
</div>

<table class="table table-bordered table-striped" id="vehiclesTable" style="display: none;">
    <thead>
        <tr>
            <th>Номер</th>
            <th>Бренд</th>
            <th>Модель</th>
            <th>Власник</th>
            <th>Дії</th>
        </tr>
    </thead>
    <tbody id="vehiclesBody">
        <!-- Дані будуть завантажені через API -->
    </tbody>
</table>

<div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

{% include "vehicles/_create_vehicle_modal.html" %}
{% include "vehicles/_edit_vehicle_modal.html" %}

{% endblock %}

{% block scripts %}
<script>
let allVehicles = [];

// Функция для получения CSRF токена из cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function loadVehicles() {
    const spinner = document.getElementById("loadingSpinner");
    const table = document.getElementById("vehiclesTable");
    const errorMsg = document.getElementById("errorMessage");
    const body = document.getElementById("vehiclesBody");

    // Показуємо спіннер, ховаємо таблицю та повідомлення про помилку
    spinner.style.display = "block";
    table.style.display = "none";
    errorMsg.style.display = "none";

    fetch("/api/vehicles/", {
        credentials: 'include'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            allVehicles = data.results || [];
            renderVehicles(allVehicles);
            
            spinner.style.display = "none";
            table.style.display = "table";
        })
        .catch(error => {
            console.error("Помилка завантаження машин:", error);
            errorMsg.textContent = `Помилка завантаження даних: ${error.message}`;
            errorMsg.style.display = "block";
            spinner.style.display = "none";
        });
}

function renderVehicles(vehicles) {
    const body = document.getElementById("vehiclesBody");
    body.innerHTML = "";

    if (vehicles.length === 0) {
        body.innerHTML = '<tr><td colspan="5" class="text-center">Машини не знайдено</td></tr>';
        return;
    }

    vehicles.forEach(vehicle => {
        const row = document.createElement("tr");
        const ownerInfo = vehicle.client 
            ? `${vehicle.client.name} (${vehicle.client.phone})`
            : '<span class="badge bg-secondary">немає</span>';
        
        row.innerHTML = `
            <td>${vehicle.plate_number || ''}</td>
            <td>${vehicle.brand || ''}</td>
            <td>${vehicle.model || ''}</td>
            <td>${ownerInfo}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="openEditVehicleModal(${vehicle.id})">
                    Редагувати
                </button>
            </td>
        `;
        body.appendChild(row);
    });
}

function createVehicle() {
    const plateInput = document.getElementById("vehiclePlateInput");
    const brandInput = document.getElementById("vehicleBrandInput");
    const modelInput = document.getElementById("vehicleModelInput");
    const clientIdInput = document.getElementById("vehicleClientId");
    const errorDiv = document.getElementById("vehicleFormError");
    const saveBtn = document.getElementById("saveVehicleBtn");
    
    const plate = plateInput.value.trim();
    const brand = brandInput.value.trim();
    const model = modelInput.value.trim();
    const clientId = clientIdInput.value ? parseInt(clientIdInput.value) : null;

    // Очищаем предыдущие ошибки
    errorDiv.style.display = "none";
    errorDiv.textContent = "";
    plateInput.classList.remove("is-invalid");
    brandInput.classList.remove("is-invalid");
    modelInput.classList.remove("is-invalid");

    // Валидация на клиенте
    if (!plate) {
        plateInput.classList.add("is-invalid");
        errorDiv.textContent = "Будь ласка, введіть номер машини";
        errorDiv.style.display = "block";
        return;
    }

    if (!brand) {
        brandInput.classList.add("is-invalid");
        errorDiv.textContent = "Будь ласка, введіть бренд";
        errorDiv.style.display = "block";
        return;
    }

    if (!model) {
        modelInput.classList.add("is-invalid");
        errorDiv.textContent = "Будь ласка, введіть модель";
        errorDiv.style.display = "block";
        return;
    }

    // Проверка на уникальность (на клиенте) - комбинация номер+бренд+модель
    const existingVehicle = allVehicles.find(v => 
        v.plate_number && v.brand && v.model &&
        v.plate_number.toLowerCase() === plate.toLowerCase() &&
        v.brand.toLowerCase() === brand.toLowerCase() &&
        v.model.toLowerCase() === model.toLowerCase()
    );
    
    if (existingVehicle) {
        errorDiv.textContent = "Машина з такими номером, брендом та моделлю вже існує";
        errorDiv.style.display = "block";
        plateInput.classList.add("is-invalid");
        brandInput.classList.add("is-invalid");
        modelInput.classList.add("is-invalid");
        return;
    }

    // Блокируем кнопку
    saveBtn.disabled = true;
    saveBtn.textContent = "Збереження...";

    // Получаем CSRF токен
    const csrftoken = getCookie('csrftoken');

    // Отправка через API
    fetch("/api/vehicles/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        credentials: 'include',
        body: JSON.stringify({ 
            plate_number: plate,
            brand: brand,
            model: model,
            ...(clientId && { client_id: clientId })
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        // Успешно создан
        const modal = bootstrap.Modal.getInstance(document.getElementById("createVehicleModal"));
        modal.hide();
        
        // Очищаем форму
        plateInput.value = "";
        brandInput.value = "";
        modelInput.value = "";
        document.getElementById("vehicleClientInput").value = "";
        clientIdInput.value = "";
        plateInput.classList.remove("is-invalid");
        brandInput.classList.remove("is-invalid");
        modelInput.classList.remove("is-invalid");
        errorDiv.style.display = "none";
        
        // Перезагружаем список
        loadVehicles();
    })
    .catch(error => {
        console.error("Помилка створення машини:", error);
        
        // Показываем ошибку
        let errorMessage = "Помилка при створенні машини";
        
        if (error.error) {
            errorMessage = error.error;
        } else if (error.detail) {
            errorMessage = error.detail;
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        // Проверяем на уникальность (ошибка от сервера)
        if (errorMessage.toLowerCase().includes("вже існує") || errorMessage.toLowerCase().includes("already exists")) {
            errorDiv.textContent = errorMessage;
            plateInput.classList.add("is-invalid");
            brandInput.classList.add("is-invalid");
            modelInput.classList.add("is-invalid");
        } else {
            errorDiv.textContent = errorMessage;
        }
        
        errorDiv.style.display = "block";
    })
    .finally(() => {
        // Разблокируем кнопку
        saveBtn.disabled = false;
        saveBtn.textContent = "Створити";
    });
}

function openEditVehicleModal(vehicleId) {
    // Находим машину в массиве
    const vehicle = allVehicles.find(v => v.id === vehicleId);
    if (!vehicle) {
        console.error("Машину не знайдено");
        return;
    }

    // Заполняем форму данными машины
    document.getElementById("editVehicleId").value = vehicle.id;
    document.getElementById("editVehiclePlateInput").value = vehicle.plate_number || '';
    document.getElementById("editVehicleBrandInput").value = vehicle.brand || '';
    document.getElementById("editVehicleModelInput").value = vehicle.model || '';

    // Отображаем текущего владельца
    const currentOwnerDiv = document.getElementById("editVehicleCurrentOwner");
    const clientSection = document.getElementById("editVehicleClientSection");
    if (vehicle.client) {
        currentOwnerDiv.innerHTML = `<span class="badge bg-primary">${vehicle.client.name} (${vehicle.client.phone})</span>`;
        // Скрываем поле выбора клиента, так как машина уже прикреплена
        clientSection.style.display = "none";
    } else {
        currentOwnerDiv.innerHTML = '<span class="badge bg-secondary">немає власника</span>';
        // Показываем поле выбора клиента, так как машина не прикреплена
        clientSection.style.display = "block";
    }

    // Очищаем поля клиента
    document.getElementById("editVehicleClientInput").value = "";
    document.getElementById("editVehicleClientId").value = "";
    document.getElementById("editVehicleClientSearchResults").style.display = "none";
    document.getElementById("editVehicleClientSearchResults").innerHTML = "";

    // Очищаем ошибки
    document.getElementById("editVehicleFormError").style.display = "none";
    document.getElementById("editVehicleFormError").textContent = "";
    document.getElementById("editVehiclePlateInput").classList.remove("is-invalid");
    document.getElementById("editVehicleBrandInput").classList.remove("is-invalid");
    document.getElementById("editVehicleModelInput").classList.remove("is-invalid");

    // Загружаем всех клиентов для поиска
    loadClientsForEdit();

    // Открываем модальное окно
    const modal = new bootstrap.Modal(document.getElementById("editVehicleModal"));
    modal.show();
}

function updateVehicle() {
    const vehicleId = document.getElementById("editVehicleId").value;
    const plateInput = document.getElementById("editVehiclePlateInput");
    const brandInput = document.getElementById("editVehicleBrandInput");
    const modelInput = document.getElementById("editVehicleModelInput");
    const clientIdInput = document.getElementById("editVehicleClientId");
    const errorDiv = document.getElementById("editVehicleFormError");
    const saveBtn = document.getElementById("saveEditVehicleBtn");
    
    const plate = plateInput.value.trim();
    const brand = brandInput.value.trim();
    const model = modelInput.value.trim();
    const clientId = clientIdInput.value ? parseInt(clientIdInput.value) : null;

    // Очищаем предыдущие ошибки
    errorDiv.style.display = "none";
    errorDiv.textContent = "";
    plateInput.classList.remove("is-invalid");
    brandInput.classList.remove("is-invalid");
    modelInput.classList.remove("is-invalid");

    // Валидация
    if (!plate) {
        plateInput.classList.add("is-invalid");
        errorDiv.textContent = "Будь ласка, введіть номер машини";
        errorDiv.style.display = "block";
        return;
    }

    if (!brand) {
        brandInput.classList.add("is-invalid");
        errorDiv.textContent = "Будь ласка, введіть бренд";
        errorDiv.style.display = "block";
        return;
    }

    if (!model) {
        modelInput.classList.add("is-invalid");
        errorDiv.textContent = "Будь ласка, введіть модель";
        errorDiv.style.display = "block";
        return;
    }

    // Блокируем кнопку
    saveBtn.disabled = true;
    saveBtn.textContent = "Збереження...";

    // Получаем CSRF токен
    const csrftoken = getCookie('csrftoken');

    // Подготавливаем данные для отправки
    const requestData = {
        plate_number: plate,
        brand: brand,
        model: model
    };

    // Добавляем client_id только если он указан
    if (clientId) {
        requestData.client_id = clientId;
    }

    // Отправка через API
    fetch(`/api/vehicles/${vehicleId}/`, {
        method: "PATCH",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        credentials: 'include',
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        // Успешно обновлено
        const modal = bootstrap.Modal.getInstance(document.getElementById("editVehicleModal"));
        modal.hide();
        
        // Перезагружаем список
        loadVehicles();
    })
    .catch(error => {
        console.error("Помилка оновлення машини:", error);
        
        let errorMessage = "Помилка при оновленні машини";
        
        if (error.error) {
            errorMessage = error.error;
        } else if (error.detail) {
            errorMessage = error.detail;
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        errorDiv.textContent = errorMessage;
        errorDiv.style.display = "block";
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = "Зберегти";
    });
}

let allClientsForEdit = [];

function loadClientsForEdit() {
    fetch("/api/clients/", {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        allClientsForEdit = data.results || [];
    })
    .catch(error => {
        console.error("Помилка завантаження клієнтів:", error);
    });
}

// Завантаження при завантаженні сторінки
document.addEventListener("DOMContentLoaded", () => {
    loadVehicles();

    // Пошук
    document.getElementById("searchInput").addEventListener("keyup", function() {
        const value = this.value.toLowerCase();
        const filtered = allVehicles.filter(vehicle => {
            const plate = (vehicle.plate_number || '').toLowerCase();
            const brand = (vehicle.brand || '').toLowerCase();
            const model = (vehicle.model || '').toLowerCase();
            const owner = vehicle.client ? 
                `${vehicle.client.name} ${vehicle.client.phone}`.toLowerCase() : '';
            return plate.includes(value) || brand.includes(value) || model.includes(value) || owner.includes(value);
        });
        renderVehicles(filtered);
    });

    // Сортування
    document.getElementById("sortSelect").addEventListener("change", function() {
        const field = this.value;
        if (!field) {
            renderVehicles(allVehicles);
            return;
        }

        const sorted = [...allVehicles];
        const isDesc = field.startsWith("-");
        const sortField = isDesc ? field.substring(1) : field;

        sorted.sort((a, b) => {
            const aVal = (a[sortField] || "").toString().toLowerCase();
            const bVal = (b[sortField] || "").toString().toLowerCase();
            const comparison = aVal.localeCompare(bVal);
            return isDesc ? -comparison : comparison;
        });

        renderVehicles(sorted);
    });

    // Обработка поиска клиентов
    let allClients = [];
    const clientInput = document.getElementById("vehicleClientInput");
    const clientResults = document.getElementById("vehicleClientSearchResults");
    const clientIdInput = document.getElementById("vehicleClientId");

    // Загружаем всех клиентов при открытии модального окна
    function loadClients() {
        fetch("/api/clients/", {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            allClients = data.results || [];
        })
        .catch(error => {
            console.error("Помилка завантаження клієнтів:", error);
        });
    }

    // Загружаем клиентов при открытии модального окна
    const createModal = document.getElementById("createVehicleModal");
    if (createModal) {
        createModal.addEventListener("show.bs.modal", function() {
            loadClients();
        });
    }

    if (clientInput) {
        clientInput.addEventListener("input", function() {
            const query = this.value.trim().toLowerCase();
            
            // Очищаем результаты если поле пустое
            if (query.length < 1) {
                clientResults.style.display = "none";
                clientResults.innerHTML = "";
                clientIdInput.value = "";
                return;
            }

            // Фильтруем клиентов на клиенте (по имени и телефону)
            const filteredClients = allClients.filter(client => {
                const name = (client.name || "").toLowerCase();
                const phone = (client.phone || "").toLowerCase();
                return name.includes(query) || phone.includes(query);
            });

            clientResults.innerHTML = "";
            
            if (filteredClients.length === 0) {
                const noResult = document.createElement("div");
                noResult.className = "list-group-item text-muted";
                noResult.textContent = "Клієнтів не знайдено";
                clientResults.appendChild(noResult);
            } else {
                filteredClients.forEach(client => {
                    const item = document.createElement("button");
                    item.type = "button";
                    item.className = "list-group-item list-group-item-action";
                    item.textContent = `${client.name} (${client.phone})`;
                    item.onclick = (e) => {
                        e.preventDefault();
                        clientInput.value = `${client.name} (${client.phone})`;
                        clientIdInput.value = client.id;
                        clientResults.style.display = "none";
                        clientResults.innerHTML = "";
                    };
                    clientResults.appendChild(item);
                });
            }
            
            clientResults.style.display = "block";
        });

        // Скрываем результаты при клике вне поля
        document.addEventListener("click", function(e) {
            if (!clientInput.contains(e.target) && !clientResults.contains(e.target)) {
                clientResults.style.display = "none";
            }
        });

        // Очищаем выбранного клиента при очистке поля
        clientInput.addEventListener("blur", function() {
            setTimeout(() => {
                if (!this.value.trim()) {
                    clientIdInput.value = "";
                }
            }, 200);
        });
    }

    // Обработка закрытия модального окна создания - очистка формы
    const modal = document.getElementById("createVehicleModal");
    if (modal) {
        modal.addEventListener("hidden.bs.modal", function() {
            document.getElementById("vehiclePlateInput").value = "";
            document.getElementById("vehicleBrandInput").value = "";
            document.getElementById("vehicleModelInput").value = "";
            document.getElementById("vehicleClientInput").value = "";
            document.getElementById("vehicleClientId").value = "";
            document.getElementById("vehicleClientSearchResults").style.display = "none";
            document.getElementById("vehicleClientSearchResults").innerHTML = "";
            document.getElementById("vehiclePlateInput").classList.remove("is-invalid");
            document.getElementById("vehicleBrandInput").classList.remove("is-invalid");
            document.getElementById("vehicleModelInput").classList.remove("is-invalid");
            document.getElementById("vehicleFormError").style.display = "none";
            document.getElementById("vehicleFormError").textContent = "";
        });
    }

    // Обработка поиска клиентов в модальном окне редактирования
    const editClientInput = document.getElementById("editVehicleClientInput");
    const editClientResults = document.getElementById("editVehicleClientSearchResults");
    const editClientIdInput = document.getElementById("editVehicleClientId");
    
    if (editClientInput) {
        editClientInput.addEventListener("input", function() {
            const query = this.value.trim().toLowerCase();
            
            // Очищаем результаты если поле пустое
            if (query.length < 1) {
                editClientResults.style.display = "none";
                editClientResults.innerHTML = "";
                editClientIdInput.value = "";
                return;
            }

            // Фильтруем клиентов на клиенте (по имени и телефону)
            const filteredClients = allClientsForEdit.filter(client => {
                const name = (client.name || "").toLowerCase();
                const phone = (client.phone || "").toLowerCase();
                return name.includes(query) || phone.includes(query);
            });

            editClientResults.innerHTML = "";
            
            if (filteredClients.length === 0) {
                const noResult = document.createElement("div");
                noResult.className = "list-group-item text-muted";
                noResult.textContent = "Клієнтів не знайдено";
                editClientResults.appendChild(noResult);
            } else {
                filteredClients.forEach(client => {
                    const item = document.createElement("button");
                    item.type = "button";
                    item.className = "list-group-item list-group-item-action";
                    item.textContent = `${client.name} (${client.phone})`;
                    item.onclick = (e) => {
                        e.preventDefault();
                        editClientInput.value = `${client.name} (${client.phone})`;
                        editClientIdInput.value = client.id;
                        editClientResults.style.display = "none";
                        editClientResults.innerHTML = "";
                    };
                    editClientResults.appendChild(item);
                });
            }
            
            editClientResults.style.display = "block";
        });

        // Скрываем результаты при клике вне поля
        document.addEventListener("click", function(e) {
            if (!editClientInput.contains(e.target) && !editClientResults.contains(e.target)) {
                editClientResults.style.display = "none";
            }
        });

        // Очищаем выбранного клиента при очистке поля
        editClientInput.addEventListener("blur", function() {
            setTimeout(() => {
                if (!this.value.trim()) {
                    editClientIdInput.value = "";
                }
            }, 200);
        });
    }

    // Обработка закрытия модального окна редактирования
    const editModal = document.getElementById("editVehicleModal");
    if (editModal) {
        editModal.addEventListener("hidden.bs.modal", function() {
            document.getElementById("editVehicleId").value = "";
            document.getElementById("editVehiclePlateInput").value = "";
            document.getElementById("editVehicleBrandInput").value = "";
            document.getElementById("editVehicleModelInput").value = "";
            document.getElementById("editVehicleClientInput").value = "";
            document.getElementById("editVehicleClientId").value = "";
            document.getElementById("editVehicleCurrentOwner").innerHTML = "";
            document.getElementById("editVehicleClientSearchResults").style.display = "none";
            document.getElementById("editVehicleClientSearchResults").innerHTML = "";
            document.getElementById("editVehiclePlateInput").classList.remove("is-invalid");
            document.getElementById("editVehicleBrandInput").classList.remove("is-invalid");
            document.getElementById("editVehicleModelInput").classList.remove("is-invalid");
            document.getElementById("editVehicleFormError").style.display = "none";
            document.getElementById("editVehicleFormError").textContent = "";
        });
    }
});
</script>
{% endblock %}
